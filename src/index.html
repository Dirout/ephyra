<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <link rel="stylesheet" href="base.css"></link>
  <link rel="stylesheet" href="custom.css"></link>
  <title>Ephyra</title>
</head>
<body>
  <div id = "profile"></div>
  <div id = "timeline"></div>
  <script src="https://cdn.jsdelivr.net/npm/ipfs-http-client/dist/index.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dompurify"></script>
  <script src="me.js" ></script>
  <script>
    const ipfs = window.IpfsHttpClient('http://localhost:5001');
    populate_profile(me);
    for (const subscription of me.subscriptions)
    {
      insert_all(subscription);
    }
    async function insert_all(ipfsPath)
    {
      var decoder = new TextDecoder('utf-8');
      var profile = "";
      for await (const chunk of ipfs.cat(ipfsPath + "/me.js")) {
        profile += decoder.decode(chunk);
      }
      var followed_profile = JSON.parse(profile.replace("var me = ", ""));
      for await (const file of ipfs.ls(ipfsPath)) {
        if (file.path.endsWith(".md") || file.path.endsWith(".markdown"))
        {
          console.log(file.path);
          insert(decoder, file.path, followed_profile, ipfsPath);
        }
      }
    }
    async function insert(decoder, ipfsPath, followed_profile, root)
    {
      var file = "";
      for await (const ipfs_file of ipfs.get(ipfsPath)) {
        for await (const chunk of ipfs_file.content) {
          file += decoder.decode(chunk);
        }
        document.getElementById('timeline').innerHTML += make_post(ipfs_file.path, render(file), followed_profile, root);
      }
    }
    function make_post(ipfsPath, content, followed_profile, root)
    {
      var html = `
      <div class = "post" id = "${ipfsPath}">
        <div class = "post-metadata">
          <a href="ipfs://${root}/index.html" class = "avatar">
              <div class = "avatar-aspect-ratio"></div>
              <img alt = "${followed_profile.name}" src = "${followed_profile.picture}" />
          </a>
          <a href="ipfs://${root}/index.html">
            <p>${followed_profile.name}</P>
          </a>
        </div>
        <div class = "post-content">
        ${content}
        </div>
      </div>
      `
      return html;
    }
    function populate_profile(me)
    {
      var html = `
      <img class = "me-picture" alt = "${me.name}" src = "${me.picture}" />
      <h1>${me.name}</h1>
      <p>${me.description}</p>
      `
      document.getElementById('profile').innerHTML = html;
    }
    function render(text)
    {
      return DOMPurify.sanitize(marked(text), {ALLOWED_URI_REGEXP: /^(?:(?:(?:f|ht)tps?|ipfs|mailto|tel|callto|cid|xmpp|xxx):|[^a-z]|[a-z+.\-]+(?:[^a-z+.\-:]|$))/i}, {USE_PROFILES: {html: true, mathMl: true, svg: true, svgFilters: true}});
    }
  </script>
</body>
</html>
